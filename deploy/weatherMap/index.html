<!DOCTYPE html>
<html lang="en" style="font-size:16px;">
<head>
	<meta charset="UTF-8">
	<meta name="viewport"
	      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet"
          href="node_modules/material-components-web/dist/material-components-web.css">
</head>
<body>
  <div class="wrapper" style="display: grid;grid-template-columns: 10vw 80vw 10vw;grid-template-rows: 10vh 10vh 35vh 40vh 5vh";>
    <div id="title" style="grid-column: 2;grid-row: 1;margin: auto;text-align: center;font-size: 2vw;">
    </div>
    <div id="search" style="grid-row: 2;grid-column: 2;margin: auto;font-size: 1vw;">
      <label for="searchLoc" style="display: block;
font-size: 2vw;">Search by City</label>
        <input id="searchLoc" type="text" autocomplete="address-level1" autocomplete="address-line3" placeholder="Press enter to submit">
    </div>
    <div id="main-content" style="grid-row: 3; grid-column: 2; display: grid; grid-template-columns: 20vw 20vw 20vw; grid-template-rows: repeat(7, 5vh); grid-auto-flow: column; margin: auto;padding: 0;text-align: center;font-size: 2vw;">
    </div>
    <div id="map" style="grid-row: 4; grid-column:2;height: 100%; width: 100%;">
    </div>
  </div>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCC7V8MzJ0RTYA8ZcR90gfjw2zP5kbH6uA">
    </script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
</script>
<script type="text/javascript">
/* global $ */
$(document).ready(function () {
  console.log("ready");

  // Locate user by IP request
  var latLng = $.getJSON("http://ip-api.com/json").done(function (data) {
    console.log(data);
    myLat = data.lat;
    myLng = data.lon;
    locate(myLat, myLng);

  // Map instantiation made with coords from JSON return
    var map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: myLat, lng: myLng},
      zoom: 8,
      disableDoubleClickZoom: true
    });

  // Marker placed at users approximate location
    var marker = new google.maps.Marker({
      position: {lat: myLat, lng: myLng},
      map: map,
      draggable: true
    });

  // Function use to add marker to the map
    function addMarker (location, map) {
      marker.setMap(null);
      marker = null;
      marker = new google.maps.Marker({
        position: location,
        map: map,
        draggable: true
      });
    }

    function geo (geocoder, map) {
      var address = $("#searchLoc").val();
      geocoder.geocode({'address': address}, function (results, status) {
        if (status === 'OK') {
          map.setCenter(results[0].geometry.location);
          marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location,
          });
        } else {
          alert('Geocode was not successful for the following reason: ' + status);
        }
      });
    };

  // Function that allows new requests to process through app
    function locate (lat, lng) {
      $('#title').html('');
      $("#main-content").html('');
      var request = $.get("http://api.openweathermap.org/data/2.5/forecast", {
        APPID: "a280d317b70b41271ed25f8e6649645e",
        lat: lat,
        lon: lng,
        cnt: 3,
        units: "imperial"
      }).done(function (data) {
        console.log(data);
        var weatherData = '';
        for (var i = 0; i < 3; i++) {
          weatherData += `<p style="margin: auto; grid-row: 1/2; grid-column:1/2;">Current</p><p style="margin: auto; grid-row: 1/2;grid-column:2/3;">Next-Day</p><p style="margin: auto; grid-row: 1/2;grid-column: 3/4;">2-Day</p>`;
          weatherData += `<div class="weather-img"><img style="height: 5vh; width: 5vh; "src="http://openweathermap.org/img/w/${data.list[i].weather[0].icon}.png" alt="Weather Image"/></div>`;
          weatherData += `<div class="temp">Temp: ${data.list[i].main.temp.toFixed(0)}</div>`;
          weatherData += `<div class="temp-min">Lo: ${data.list[i].main.temp_min.toFixed(0)}</div>`;
          weatherData += `<div class="temp-max">Hi: ${data.list[i].main.temp_max.toFixed(0)}</div>`;
          weatherData += `<div class="wind">Wind: ${data.list[i].wind.speed.toFixed(0)}MPH</div>`;
          weatherData += `<div class="humidty">Humidity: ${data.list[i].main.humidity}</div>`;
        }
        $('#title').html(`<h1>Weather for ${data.city.name}</h1>`);
        $("#main-content").append(weatherData);
      });
    }
    // Event listener for drag event to get new coords
    google.maps.event.addListener(marker, 'dragend', function (event) {
      let newLat = marker.getPosition().lat();
      let newLng = marker.getPosition().lng();
      locate(newLat, newLng);
    });

    // Event listener to drop new pin on location with dblclick
    google.maps.event.addListener(map, 'dblclick', function (event) {
      map.setCenter(addMarker(event.latLng, map));
      console.log(map.setCenter(addMarker(event.latLng, map)));
      let newLat = marker.getPosition().lat();
      let newLng = marker.getPosition().lng();
      locate(newLat, newLng);
    });
    // Function to geolocate based on address
    $("#searchLoc").keypress(function (e) {
      if (e.keyCode == "13") {
        var geocoder = new google.maps.Geocoder();
        geo(geocoder, map);
      }
    });
  });
});
</script>

</body>
</html>
